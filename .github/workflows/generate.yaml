name: Generate Container Guts
on:
#  pull_request: []
  workflow_dispatch: 
    inputs:
      docker_uri:
        description: 'Docker identifier to generate recipe for'
        required: true
        default: "quay.io/autamus/clingo:5.5.1"
jobs:
  generate-recipe:
    if: (inputs.docker_uri != '')
    runs-on: ubuntu-latest
    permissions:
      packages: read
    name: ${{ inputs.docker_uri }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Create conda environment
        run: conda create --quiet -c conda-forge --name guts

      - uses: actions/checkout@v3
      - name: Install Guts
        run: |
          export PATH="/usr/share/miniconda/bin:$PATH"
          source activate guts
          pip install -e .

      - name: Guts for ${{ inputs.docker_uri }}
        uses: ./manifest
        with:
          image: ${{ inputs.docker_uri }}

  generate-recipes:
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:     
        image: ["ubuntu", "centos", "rockylinux:9.0", "alpine", "busybox"]

    name: Generate Matrix
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Create conda environment
        run: conda create --quiet -c conda-forge --name guts

      - uses: actions/checkout@v3
      - name: Install Guts
        run: |
          export PATH="/usr/share/miniconda/bin:$PATH"
          source activate guts
          pip install -e .

      - name: Guts for ${{ matrix.image }}
        uses: ./manifest
        with:
          image: ${{ matrix.image }}
          outfile: ${{ matrix.image }}.json
      - name: View Output
        run: cat ${{ matrix.image }}.json

